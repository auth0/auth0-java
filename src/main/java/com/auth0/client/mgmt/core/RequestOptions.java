/**
 * This file was auto-generated by Fern from our API Definition.
 *
 * MODIFIED: Added support for per-request OAuth client credentials.
 * This allows overriding OAuth credentials on a per-request basis.
 */
package com.auth0.client.mgmt.core;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.TimeUnit;
import java.util.function.Supplier;

public final class RequestOptions {
    private final String token;

    private final Optional<Integer> timeout;

    private final TimeUnit timeoutTimeUnit;

    private final Map<String, String> headers;

    private final Map<String, Supplier<String>> headerSuppliers;

    // Per-request OAuth credentials
    private final String clientId;

    private final String clientSecret;

    private final String audience;

    private final String baseUrl;

    // Cached token supplier for per-request credentials (lazily initialized)
    private transient volatile OAuthTokenSupplier cachedTokenSupplier;

    private RequestOptions(
            String token,
            Optional<Integer> timeout,
            TimeUnit timeoutTimeUnit,
            Map<String, String> headers,
            Map<String, Supplier<String>> headerSuppliers,
            String clientId,
            String clientSecret,
            String audience,
            String baseUrl) {
        this.token = token;
        this.timeout = timeout;
        this.timeoutTimeUnit = timeoutTimeUnit;
        this.headers = headers;
        this.headerSuppliers = headerSuppliers;
        this.clientId = clientId;
        this.clientSecret = clientSecret;
        this.audience = audience;
        this.baseUrl = baseUrl;
    }

    public Optional<Integer> getTimeout() {
        return timeout;
    }

    public TimeUnit getTimeoutTimeUnit() {
        return timeoutTimeUnit;
    }

    /**
     * Returns the client ID for per-request OAuth credentials, if set.
     */
    public String getClientId() {
        return clientId;
    }

    /**
     * Returns the client secret for per-request OAuth credentials, if set.
     */
    public String getClientSecret() {
        return clientSecret;
    }

    /**
     * Returns the audience for per-request OAuth credentials, if set.
     */
    public String getAudience() {
        return audience;
    }

    /**
     * Checks if per-request OAuth credentials have been configured.
     */
    public boolean hasClientCredentials() {
        return clientId != null && clientSecret != null;
    }

    /**
     * Gets the base URL for per-request OAuth token fetching.
     */
    public String getBaseUrl() {
        return baseUrl;
    }

    /**
     * Gets the HTTP headers for this request.
     *
     * <p><b>Note:</b> When per-request OAuth credentials are configured, this method will
     * automatically fetch an access token (blocking network call). Tokens are cached and reused.
     *
     * @return Map of HTTP header names to values
     * @throws OAuthTokenException if OAuth token fetching fails
     */
    public Map<String, String> getHeaders() {
        Map<String, String> headers = new HashMap<>();

        if (hasClientCredentials() && baseUrl != null) {
            if (cachedTokenSupplier == null) {
                synchronized (this) {
                    if (cachedTokenSupplier == null) {
                        cachedTokenSupplier = new OAuthTokenSupplier(clientId, clientSecret, baseUrl, audience);
                    }
                }
            }
            headers.put("Authorization", "Bearer " + cachedTokenSupplier.get());
        } else if (this.token != null) {
            headers.put("Authorization", "Bearer " + this.token);
        }

        headers.putAll(this.headers);
        this.headerSuppliers.forEach((key, supplier) -> {
            headers.put(key, supplier.get());
        });
        return headers;
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private String token = null;

        private Optional<Integer> timeout = Optional.empty();

        private TimeUnit timeoutTimeUnit = TimeUnit.SECONDS;

        private final Map<String, String> headers = new HashMap<>();

        private final Map<String, Supplier<String>> headerSuppliers = new HashMap<>();

        private String clientId = null;

        private String clientSecret = null;

        private String audience = null;

        private String baseUrl = null;

        public Builder token(String token) {
            this.token = token;
            return this;
        }

        /**
         * Sets the base URL for OAuth token requests.
         * This is required when using per-request client credentials.
         *
         * @param baseUrl The Auth0 base URL (e.g., "https://your-domain.auth0.com")
         * @return This builder for method chaining
         */
        public Builder baseUrl(String baseUrl) {
            this.baseUrl = baseUrl;
            return this;
        }

        /**
         * Sets OAuth client credentials for this request only.
         * This overrides any client-level authentication and fetches a new token
         * using the provided credentials.
         *
         * Useful for multi-tenant scenarios where different requests need different OAuth tokens.
         *
         * Note: You must also call baseUrl() to specify where to fetch the token from.
         *
         * @param clientId The OAuth client ID
         * @param clientSecret The OAuth client secret
         * @return This builder for method chaining
         */
        public Builder clientCredentials(String clientId, String clientSecret) {
            this.clientId = clientId;
            this.clientSecret = clientSecret;
            return this;
        }

        /**
         * Sets OAuth client credentials with a custom audience for this request only.
         *
         * Note: You must also call baseUrl() to specify where to fetch the token from.
         *
         * @param clientId The OAuth client ID
         * @param clientSecret The OAuth client secret
         * @param audience The custom audience for the token request
         * @return This builder for method chaining
         */
        public Builder clientCredentialsWithAudience(String clientId, String clientSecret, String audience) {
            this.clientId = clientId;
            this.clientSecret = clientSecret;
            this.audience = audience;
            return this;
        }

        public Builder timeout(Integer timeout) {
            this.timeout = Optional.of(timeout);
            return this;
        }

        public Builder timeout(Integer timeout, TimeUnit timeoutTimeUnit) {
            this.timeout = Optional.of(timeout);
            this.timeoutTimeUnit = timeoutTimeUnit;
            return this;
        }

        public Builder addHeader(String key, String value) {
            this.headers.put(key, value);
            return this;
        }

        public Builder addHeader(String key, Supplier<String> value) {
            this.headerSuppliers.put(key, value);
            return this;
        }

        public RequestOptions build() {
            return new RequestOptions(
                    token,
                    timeout,
                    timeoutTimeUnit,
                    headers,
                    headerSuppliers,
                    clientId,
                    clientSecret,
                    audience,
                    baseUrl);
        }
    }

    /**
     * Convenience method to create RequestOptions with client credentials.
     *
     * @param baseUrl The Auth0 base URL (e.g., "https://your-domain.auth0.com")
     * @param clientId The OAuth client ID
     * @param clientSecret The OAuth client secret
     * @return RequestOptions configured with the provided credentials
     */
    public static RequestOptions withClientCredentials(String baseUrl, String clientId, String clientSecret) {
        return builder()
                .baseUrl(baseUrl)
                .clientCredentials(clientId, clientSecret)
                .build();
    }

    /**
     * Convenience method to create RequestOptions with client credentials and custom audience.
     *
     * @param baseUrl The Auth0 base URL (e.g., "https://your-domain.auth0.com")
     * @param clientId The OAuth client ID
     * @param clientSecret The OAuth client secret
     * @param audience The custom audience for the token request
     * @return RequestOptions configured with the provided credentials and audience
     */
    public static RequestOptions withClientCredentialsAndAudience(
            String baseUrl, String clientId, String clientSecret, String audience) {
        return builder()
                .baseUrl(baseUrl)
                .clientCredentialsWithAudience(clientId, clientSecret, audience)
                .build();
    }
}
